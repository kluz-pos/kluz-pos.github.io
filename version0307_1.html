<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema POS</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f7f6;
    }
    .sidebar {
      width: 240px;
      background: #03543f;
      color: white;
      height: 100vh;
      position: fixed;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
    }
    .sidebar img {
      height: 55px;
      width: auto;
    }
    .sidebar button {
      background: none;
      border: none;
      color: white;
      text-align: left;
      width: 100%;
      padding: 15px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
    .sidebar button:hover {
      background: #044c39;
    }
    .main {
      margin-left: 240px;
      padding: 40px;
    }
    .hidden {
      display: none;
    }
    input, select, textarea {
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #055f47;
      color: white;
    }
    .login {
      max-width: 400px;
      margin: 100px auto;
      padding: 40px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: white;
    }
    .login input {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      font-size: 1rem;
    }
    .login button {
      background: #03543f;
      color: white;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
    }
    .product-card {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
      background: white;
      width: 200px;
      cursor: pointer;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .product-card:hover {
      transform: scale(1.03);
    }
    .venta-contenedor {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    .inventario-contenedor {
      display: flex;
      flex-direction: column;  /* Una secci√≥n debajo de la otra */
      gap: 30px;
    }

    .venta-section {
      flex: 1;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px; /* NUEVO */
    }
    .venta-section h3 {
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 20px;
      color: #03543f;
    }
    #carrito ul {
      list-style: none;
      padding-left: 0;
    }
    .remove-btn {
      color: red;
      font-weight: bold;
      margin-left: 10px;
      cursor: pointer;
    }
    .btn-cobrar {
      margin-top: 15px;
      background-color: #03543f;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn-cobrar:hover {
      background-color: #02765c;
    }

    @media (max-width: 768px) {
  .sidebar {
    width: 100%;
    height: auto;
    flex-direction: row;
    flex-wrap: wrap;
    position: static;
    padding: 10px;
    justify-content: space-around;
  }

  .sidebar button {
    width: auto;
    font-size: 0.85rem;
    padding: 10px;
  }

  .main {
    margin-left: 0;
    padding: 20px;
  }

  .venta-contenedor {
    flex-direction: column;
    gap: 20px;
  }

  .venta-section {
    padding: 15px;
  }

  table, thead, tbody, th, td, tr {
    display: block;
    width: 100%;
  }

  thead {
    display: none;
  }

  tr {
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    background: white;
  }

  td {
    display: flex;
    justify-content: space-between;
    padding: 6px 10px;
    font-size: 0.9rem;
  }

  td::before {
    content: attr(data-label);
    font-weight: bold;
  }
}
    </style>
</head>
<body>
<div id="login" class="login">
  <h2>Iniciar Sesi√≥n</h2>
  <input type="text" id="usuario" placeholder="Usuario">
  <input type="password" id="contrasena" placeholder="Contrase√±a">
  <button id="btn-login">Ingresar</button>
</div>

<div id="app" class="hidden">
  <div class="sidebar">
    <img src="https://dlfkzcwhyopbghkqrzcy.supabase.co/storage/v1/object/public/logosweb/logo%20Kluz.jpeg"
     alt="Logo POS"
     style="height: 60px; object-fit: contain; margin-bottom: 20px;">
    <button onclick="mostrarPanel('venta')">üõí Punto de Venta</button>
    <button onclick="mostrarPanel('inventario')">üì¶ Inventario</button>
    <button onclick="mostrarPanel('reportes')">üìä Reportes</button>
    <button onclick="mostrarPanel('clientes')">üë• Clientes</button>
    <button onclick="mostrarPanel('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
    <button onclick="mostrarPanel('caja')">üí∞ Gesti√≥n de Caja</button>
    <button onclick="mostrarPanel('restaurante')">üçΩÔ∏è Restaurante Atenci√≥n</button>
    <button onclick="mostrarPanel('mesas')">ü™ë Atenci√≥n Mesas</button>
    <button onclick="mostrarPanel('usuarios')">üë§ Gesti√≥n de Usuarios</button>
    <hr style="width: 80%; border: 0.5px solid #fff; margin: 20px 0;">
    <button onclick="cerrarSesion()">üîì Cerrar sesi√≥n</button>

  </div>

<div class="main">
    <div id="usuario-logueado" style="text-align:right; font-weight:bold; margin-bottom:20px;"></div>
    <div id="venta" class="panel">
      <h2>Punto de Venta</h2>
      <div class="venta-contenedor">
        <div class="venta-section">
          <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0;">PRODUCTOS</h3>
              <div style="position: relative; display: flex; align-items: center;">
              <span style="position: absolute; left: 10px; font-size: 1rem; color: #888;">üîç</span>
              <input type="text" id="busqueda-producto" placeholder="Buscar producto..."
                      style="padding: 6px 12px 6px 32px; font-size: 0.9rem; border-radius: 20px; border: 1px solid #ccc; width: 200px;">
              </div>
          </div>
          <div id="productos-venta" style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px;"></div> 
        </div>
        <div class="venta-section">
          <h3>CARRITO</h3>
          <ul id="carrito-lista"></ul>
          <p>Total: S/ <span id="carrito-total">0.00</span></p>
          <button class="btn-cobrar" onclick="cobrar()">Cobrar</button>
        </div>
      </div>
    </div>

<div id="inventario" class="panel hidden">
  <h2>Inventario</h2>

  <div class="inventario-contenedor">
  <div class="venta-section">
    <h3>Informaci√≥n del Producto</h3>

    <form id="form-producto" style="max-width: 100%;">
      <style>
        .form-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 20px 30px;
        }

        .form-group {
          display: flex;
          flex-direction: column;
        }

        .form-group label {
          margin-bottom: 5px;
          font-weight: 600;
        }

        input, select, textarea {
          font-size: 0.95rem;
          padding: 8px 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
        }

        textarea {
          resize: vertical;
          min-height: 80px;
        }

        #descripcion {
          width: 100%;
        }

        .form-full {
          grid-column: span 2;
        }

        .form-small {
          max-width: 150px;
        }

        .btn-registrar {
          background-color: #03543f;
          color: white;
          border: none;
          padding: 10px 18px;
          border-radius: 5px;
          font-size: 1rem;
          cursor: pointer;
          width: fit-content;
        }

        .btn-registrar:hover {
          background-color: #02765c;
        }
        .input-inventario {
          width: 100%;
          max-width: 250px;
        }

        .textarea-descripcion {
            width: 100%;
            max-width: 500px;
            height: 80px;
            resize: none; /* Puedes poner none para bloquear el cambio manual */
        }

      </style>

      <div class="form-grid">
        <div class="form-group">
          <label for="nombre">Nombre</label>
          <input type="text" id="nombre" required>
        </div>

        <div class="form-group form-small">
          <label for="precio">Precio</label>
          <input type="number" id="precio" step="0.01" min="0" required>
        </div>

        <div class="form-group">
          <label for="cantidad">Cantidad</label>
          <input type="number" id="cantidad" required>
        </div>

        <div class="form-group">
          <label for="codigo">C√≥digo</label>
          <input type="text" id="codigo" class="input-inventario">
        </div>

        <div class="form-group">
          <label for="categoria">Categor√≠a</label>
          <input type="text" id="categoria">
        </div>

        <div class="form-group">
          <label for="sucursal">Sucursal</label>
          <select id="sucursal">
            <option value="Central">Sucursal Central</option>
            <option value="Norte">Sucursal Norte</option>
            <option value="Sur">Sucursal Sur</option>
          </select>
        </div>

        <div class="form-group form-full">
          <label for="descripcion">Descripci√≥n</label>
          <textarea id="descripcion" class="textarea-descripcion" placeholder="Descripci√≥n del producto..."></textarea>
        </div>

        <div class="form-group form-full">
          <button type="submit" class="btn-registrar">Registrar Producto</button>
        </div>
      </div>
    </form>
  </div>

  <div class="venta-section">
    <h3 style="display: flex; justify-content: space-between; align-items: center;">
        <span>Productos Registrados</span>
        <span style="position: relative;">
          <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #888;">üîç</span>
          <input type="text" id="busqueda-inventario" placeholder="Buscar producto..."
            style="padding: 6px 12px 6px 32px; font-size: 0.9rem; border-radius: 20px; border: 1px solid #ccc; width: 200px;">
        </span>
    </h3>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Cantidad</th>
          <th>C√≥digo</th>
          <th>Categor√≠a</th>
          <th>Sucursal</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="lista-productos"></tbody>
    </table>
  </div>
</div>


    <div id="reportes" class="panel hidden">
      <h2>Reportes</h2>
      <canvas id="graficoVentas" width="400" height="200"></canvas>
      <canvas id="graficoProductos" width="400" height="200"></canvas>
    </div>

    <div id="clientes" class="panel hidden">
      <h2>Clientes</h2>
      <p>Gestion por implementar.</p>
    </div>

    <div id="configuracion" class="panel hidden">
      <h2>ConfiguraciË¥∏n</h2>
      <p>Opciones de sistema por implementar.</p>
    </div>
  </div>
  <div id="usuarios" class="panel hidden">
  <h2>Gesti√≥n de Usuarios</h2>

  <div class="venta-contenedor" style="flex-direction: column; gap: 30px;">
    <div class="venta-section">
      <h3>Crear Nuevo Usuario</h3>
      <form onsubmit="event.preventDefault(); crearUsuario();">
        <style>
          .form-usuario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
          }
          .form-usuario-group {
            display: flex;
            flex-direction: column;
          }
          .form-usuario-group label {
            font-weight: 600;
            margin-bottom: 5px;
          }
          .form-usuario-group input {
            padding: 8px;
            font-size: 0.95rem;
          }
          .permiso-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
          }
          .permiso-checkboxes label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
          }
          .btn-crear-usuario {
            margin-top: 20px;
            background-color: #03543f;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
          }
          .btn-crear-usuario:hover {
            background-color: #02765c;
          }

          .input-usuario {
            width: 100%;
            max-width: 250px;
          }
          
        </style>

        <div class="form-usuario-grid">
          <div class="form-usuario-group">
            <label for="nuevoUsuario">Nombre de Usuario</label>
            <input type="text" id="nuevo-usuario" placeholder="Nombre de Usuario" required>
          </div>
          <div class="form-usuario-group">
            <label for="nuevaContrasena">Contrase√±a</label>
            <input type="password" id="nueva-clave" placeholder="Contrase√±a" required>

          </div>

          <div class="form-usuario-group">
              <label for="fechaExpiracion">Fecha de Expiraci√≥n</label>
              <input type="date" id="fecha-expiracion">
          </div>

        </div>

        <label style="font-weight: 600; margin-top: 15px;">Permisos</label>
        <div class="permiso-checkboxes">
          <label><input type="checkbox" class="permiso" value="venta"> Punto de Venta</label>
          <label><input type="checkbox" class="permiso" value="inventario"> Inventario</label>
          <label><input type="checkbox" class="permiso" value="reportes"> Reportes</label>
          <label><input type="checkbox" class="permiso" value="clientes"> Clientes</label>
          <label><input type="checkbox" class="permiso" value="configuracion"> Configuraci√≥n</label>
          <label><input type="checkbox" class="permiso" value="caja"> Gesti√≥n de Caja</label>
          <label><input type="checkbox" class="permiso" value="restaurante"> Restaurante Atenci√≥n</label>
          <label><input type="checkbox" class="permiso" value="mesas"> Atenci√≥n Mesas</label>
        </div>

        <button type="submit" class="btn-crear-usuario">Crear Usuario</button>
      </form>
    </div>

    <div class="venta-section">
  <h3>Usuarios Registrados</h3>
  <table>
    <thead>
      <tr>
        <th>Usuario</th>
        <th>Permisos</th>
        <th>Expira</th>
       <th>Acciones</th>
      </tr>
    </thead>
  <tbody id="tabla-usuarios"></tbody>
  </table>
  </div>
</div>
</div>

<div id="caja" class="panel hidden">
  <h2>Gesti√≥n de Caja</h2>

  <div class="venta-section">
    <h3>Apertura de Caja</h3>
    <form id="form-apertura">
      <label for="saldoInicial">Saldo Inicial:</label>
      <input type="number" id="saldoInicial" required>
      <label for="sucursalCaja">Sucursal:</label>
      <select id="sucursalCaja">
        <option value="Central">Central</option>
        <option value="Norte">Norte</option>
        <option value="Sur">Sur</option>
      </select>
      <button type="submit" class="btn-cobrar">Abrir Caja</button>
    </form>
  </div>

  <div class="venta-section">
    <h3>Cierre de Caja</h3>
    <button onclick="cerrarCaja()" class="btn-cobrar">Cerrar Caja</button>
  </div>

  <div class="venta-section">
    <h3>Cajas Registradas</h3>
    <table>
      <thead>
        <tr>
          <th>Fecha Apertura</th>
          <th>Saldo Inicial</th>
          <th>Fecha Cierre</th>
          <th>Saldo Final</th>
          <th>Ventas Totales</th>
          <th>Estado</th>
          <th>Sucursal</th>
        </tr>
      </thead>
      <tbody id="tabla-cajas"></tbody>
    </table>
  </div>
</div>

<div id="restaurante" class="panel hidden">
  <h2>Restaurante - Platos del D√≠a</h2>
  <form id="form-plato">
    <input type="text" id="nombrePlato" placeholder="Nombre del plato" required>
    <textarea id="descripcionPlato" placeholder="Descripci√≥n"></textarea>
    <input type="number" id="precioPlato" placeholder="Precio" required>
    <!-- AQU√ç CAMBIAREMOS ESTO: -->
    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
      <label style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
        <input type="checkbox" id="disponiblePlato"> Disponible
      </label>
      <button type="submit" class="btn-registrar">Registrar Plato</button>
    </div>
  </form>
  <hr>
  <h3>Platos Registrados</h3>
  <div id="lista-platos"></div>
</div>

<div id="mesas" class="panel hidden">
  <h2>Atenci√≥n de Mesas</h2>
  <div id="platos-disponibles" class="venta-contenedor"></div>

  <div class="venta-section">
    <h3>Carrito Pedido</h3>
    <ul id="carrito-mesas"></ul>
    <label>N√∫mero de Mesa: <input type="text" id="numeroMesa"></label>
    <button onclick="registrarPedido()" class="btn-registrar">Registrar Pedido</button>
  </div>

  <div class="venta-section">
    <h3>Pedidos Activos</h3>
    <div id="lista-pedidos"></div>
  </div>
   <!-- NUEVO: Historial de pedidos pagados -->
  <div class="venta-section">
    <h3>Historial de Pedidos Pagados</h3>
    <div id="historial-pedidos"></div>
  </div>

</div>

</div>

<script>
  
  function mostrarPanel(id) {
  const permisosUsuario = JSON.parse(localStorage.getItem("permisosUsuario") || "[]");

  if (!permisosUsuario.includes(id) && id !== "usuarios") {
    alert("No tienes permiso para acceder a esta secci√≥n.");
    return;
  }

  document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
  document.getElementById(id)?.classList.remove('hidden');
  if (id === 'venta') {
    listarProductosVenta(); // ‚úÖ Cargar productos solo en vista de venta
  }
}

</script>
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // ‚úÖ Tus credenciales reales
  const SUPABASE_URL = "https://dlfkzcwhyopbghkqrzcy.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsZmt6Y3doeW9wYmdoa3FyemN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1ODkzODgsImV4cCI6MjA2NzE2NTM4OH0.AjGB6MYYMYVmB7jIhZ7wd3IUb9QWh2ZI1GAywmtC58s";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  let carrito = []; // Se mueve la declaraci√≥n de carrito a un √°mbito m√°s amplio

  //Atencion de resturante
  document.getElementById('form-plato').addEventListener('submit', async function (e) {
  e.preventDefault();
  const nombre = document.getElementById('nombrePlato').value.trim();
  const descripcion = document.getElementById('descripcionPlato').value.trim();
  const precio = parseFloat(document.getElementById('precioPlato').value);
  const disponible = document.getElementById('disponiblePlato').checked;
  const creado_por = localStorage.getItem("usuarioActivo");

  const { error } = await supabase.from('platos_restaurante').insert([{ nombre, descripcion, precio, disponible, creado_por }]);
  if (error) {
    alert("Error: " + error.message);
    return;
  }
  alert("Plato registrado");
  listarPlatosRestaurante();
});

async function listarPlatosRestaurante() {
  const { data, error } = await supabase.from("platos_restaurante").select("*").order('id', { ascending: false });
  const contenedor = document.getElementById("lista-platos");
  contenedor.innerHTML = "";

  data.forEach(p => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.justifyContent = "space-between";
    div.style.alignItems = "center";
    div.style.borderBottom = "1px solid #ccc";
    div.style.padding = "8px 0";

    const texto = document.createElement("span");
    texto.textContent = `${p.nombre.toUpperCase()} - S/ ${p.precio} - ${p.disponible ? 'Disponible' : 'No disponible'}`;

    const boton = document.createElement("button");
    boton.textContent = "Eliminar";
    boton.style = "background-color: red; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;";
    boton.onclick = () => eliminarPlato(p.id);

    div.appendChild(texto);
    div.appendChild(boton);
    contenedor.appendChild(div);
  });
}

async function eliminarPlato(id) {
  if (!confirm("¬øEliminar este plato?")) return;

  const { error } = await supabase.from("platos_restaurante").delete().eq("id", id);
  if (error) {
    alert("Error al eliminar el plato: " + error.message);
    return;
  }

  alert("‚úÖ Plato eliminado correctamente.");
  listarPlatosRestaurante();
}

async function mostrarPlatosMesas() {
  const { data, error } = await supabase.from("platos_restaurante").select("*").eq("disponible", true);
  if (error) {
    console.error("Error al listar platos disponibles:", error.message);
    return;
  }

  const contenedor = document.getElementById("platos-disponibles");
  contenedor.innerHTML = "";

  data.forEach(plato => {
    const div = document.createElement("div");
    div.className = "product-card";
    div.innerHTML = `
      <strong>${plato.nombre}</strong><br>
      S/ ${plato.precio.toFixed(2)}
    `;
    div.onclick = () => agregarPlatoAlCarrito(plato);
    contenedor.appendChild(div);
  });
}

let carritoMesas = [];

function agregarPlatoAlCarrito(plato) {
  const existente = carritoMesas.find(p => p.id === plato.id);
  if (existente) {
    existente.cantidad++;
  } else {
    carritoMesas.push({ ...plato, cantidad: 1 });
  }
  renderCarritoMesas();
}

function renderCarritoMesas() {
  const ul = document.getElementById("carrito-mesas");
  ul.innerHTML = "";
  carritoMesas.forEach((p, i) => {
    const li = document.createElement("li");
    li.textContent = `${p.nombre} x${p.cantidad} (S/ ${p.precio * p.cantidad})`;
    const btn = document.createElement("button");
    btn.textContent = "‚ùå";
    btn.onclick = () => {
      carritoMesas.splice(i, 1);
      renderCarritoMesas();
    };
    li.appendChild(btn);
    ul.appendChild(li);
  });
}

async function registrarPedido() {
  const numeroMesa = document.getElementById("numeroMesa").value.trim();
  if (!numeroMesa || carritoMesas.length === 0) return alert("Completa el n√∫mero de mesa y agrega platos.");

  const platos = carritoMesas.map(p => ({
    id_plato: p.id,
    nombre: p.nombre,
    precio: p.precio,
    cantidad: p.cantidad
  }));

  const { error } = await supabase.from("pedidos_restaurante").insert([{
    numero_mesa: numeroMesa,
    estado: "pendiente",
    platos,
    fecha: new Date().toISOString()
  }]);

  if (error) return alert("Error al registrar pedido");
  alert("Pedido registrado");
  carritoMesas = [];
  renderCarritoMesas();
  listarPedidos();
}

async function listarPedidos() {
  const { data } = await supabase.from("pedidos_restaurante").select("*").order('fecha', { ascending: false });
  const cont = document.getElementById("lista-pedidos");
  cont.innerHTML = "";

  data.forEach(p => {
    const div = document.createElement("div");
    div.style.border = "1px solid #ccc";
    div.style.marginBottom = "10px";
    div.style.padding = "10px";

    div.innerHTML = `
      <strong>Mesa ${p.numero_mesa}</strong> - ${p.estado}<br>
      ${p.platos.map(pl => `${pl.nombre} x${pl.cantidad}`).join("<br>")}
      <br>
    `;

    if (p.estado === "pendiente") {
      const btnCobrar = document.createElement("button");
      btnCobrar.textContent = "Cobrar";
      btnCobrar.className = "btn-cobrar";
      btnCobrar.onclick = () => cobrarPedido(p.id, p.platos);
      div.appendChild(btnCobrar);
    }

    const btnEliminar = document.createElement("button");
    btnEliminar.textContent = "Eliminar";
    btnEliminar.className = "btn-registrar";
    btnEliminar.onclick = () => eliminarPedido(p.id);
    div.appendChild(btnEliminar);

    cont.appendChild(div);
  });
}


async function eliminarPedido(id) {
  if (!confirm("¬øEliminar pedido?")) return;
  await supabase.from("pedidos_restaurante").delete().eq("id", id);
  listarPedidos();
}

async function cobrarPedido(id, platos) {
  const total = platos.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);

  if (!confirm(`¬øCobrar S/ ${total.toFixed(2)} por este pedido?`)) return;

  const usuario = localStorage.getItem("usuarioActivo");
  if (!usuario) {
    alert("Usuario no identificado.");
    return;
  }

  if (!cajaActualId) {
    alert("‚ö†Ô∏è No hay caja abierta. Debes abrir una caja antes de cobrar.");
    return;
  }

  // üîç Validamos que los campos est√©n correctos
  const productosLimpios = platos.map(p => ({
    nombre: p.nombre || "sin_nombre",
    precio: Number(p.precio) || 0,
    cantidad: Number(p.cantidad) || 1
  }));

  const { error: errorVenta } = await supabase.from("registros_venta").insert([{
    caja_id: cajaActualId,
    fecha_venta: obtenerFechaLocalISO(),
    total_venta: total,
    detalle_productos: productosLimpios, // Array limpio y validado
    usuario_id: usuario
  }]);

  if (errorVenta) {
    console.error("Error al insertar en registros_venta:", errorVenta);
    alert("Error al registrar el cobro en la caja: " + errorVenta.message);
    return;
  }

  // Actualiza estado del pedido
  const { error } = await supabase
    .from("pedidos_restaurante")
    .update({ estado: "pagado" })
    .eq("id", id);

  if (error) {
    alert("Error al actualizar estado del pedido: " + error.message);
    return;
  }

  alert("‚úÖ Pedido cobrado y registrado correctamente.");
  listarPedidos();
  listarHistorialPedidos();
} 



async function listarHistorialPedidos() {
  const { data } = await supabase.from("pedidos_restaurante").select("*").eq("estado", "pagado").order("fecha", { ascending: false });

  const cont = document.getElementById("historial-pedidos");
  cont.innerHTML = "";

  data.forEach(p => {
    const div = document.createElement("div");
    div.style.border = "1px solid #ccc";
    div.style.marginBottom = "10px";
    div.style.padding = "10px";
    div.innerHTML = `
      <strong>Mesa ${p.numero_mesa}</strong> - ${new Date(p.fecha).toLocaleString()}<br>
      ${p.platos.map(pl => `${pl.nombre} x${pl.cantidad}`).join("<br>")}
      <br><strong>Total: S/ ${p.platos.reduce((s, pl) => s + pl.precio * pl.cantidad, 0).toFixed(2)}</strong>
    `;
    cont.appendChild(div);
  });
}

//aqui termina atencion de restaurante

 async function login() {
    const usuario = document.getElementById("usuario").value.trim();
    const contrasena = document.getElementById("contrasena").value.trim();

    if (!usuario || !contrasena) {
      alert("‚ùó Debes ingresar usuario y contrase√±a.");
      return;
    }

    const { data, error } = await supabase
      .from("usuarios")
      .select("usuario, contrasena, permisos, fecha_expiracion")
      .eq("usuario", usuario)
      .eq("contrasena", contrasena)
      .single();

    if (error || !data) {
      alert("‚ùå Credenciales incorrectas o error de conexi√≥n.");
      return;
    }

    // Verificar expiraci√≥n si existe
    if (data.fecha_expiracion) {
      const ahora = new Date();
      const expiracion = new Date(data.fecha_expiracion);
      if (expiracion < ahora) {
        alert("‚ö†Ô∏è Este usuario ha expirado. Contacte al administrador.");
        return;
      }
    }

    // Guardar sesi√≥n en localStorage
    localStorage.setItem("usuarioActivo", data.usuario);
    localStorage.setItem("permisosUsuario", JSON.stringify(data.permisos));

    // Ocultar login y mostrar app
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");

    const contenedor = document.getElementById("usuario-logueado");
    if (contenedor) contenedor.textContent = `üë§ Usuario: ${data.usuario}`;

    // Aplicar permisos
    aplicarPermisosDelUsuario(data);

    // Ir al panel por defecto
    mostrarPanel("venta");
  } // Se cierra correctamente la funci√≥n login aqu√≠.

  // Todas las funciones siguientes deben estar FUERA de la funci√≥n login
  function aplicarPermisosDelUsuario(usuario) {
  const secciones = ["venta", "inventario", "reportes", "clientes", "configuracion", "usuarios", "caja", "restaurante", "mesas"];// A√ëADE "usuarios" AQU√ç   
  secciones.forEach(seccion => {
    const boton = Array.from(document.querySelectorAll('.sidebar button'))
      // Ajusta esta b√∫squeda para que coincida con el texto real del bot√≥n
      .find(b => {
          if (seccion === 'usuarios') return b.textContent.includes('Gesti√≥n de Usuarios');
          return b.textContent.toLowerCase().includes(seccion);
      });
    if (boton) {
      boton.style.display = usuario.permisos.includes(seccion) ? 'block' : 'none';
    }
  });
}

let cajaActualId = null; // almacena la caja abierta actual

  async function cobrar() {
  try {
    if (!cajaActualId) {
      alert("‚ö†Ô∏è No hay caja abierta. Debes abrir una caja antes de cobrar.");
      return;
    }

    if (!carrito || carrito.length === 0) {
      alert("El carrito est√° vac√≠o.");
      return;
    }

    const totalVenta = carrito.reduce((acc, item) => acc + item.precio * item.cantidadEnCarrito, 0);
    const usuario = localStorage.getItem("usuarioActivo");

    const detalle = carrito.map(item => ({
      nombre: item.nombre,
      precio: item.precio,
      cantidad: item.cantidadEnCarrito
    }));

    const { error } = await supabase.from("registros_venta").insert([
      {
        caja_id: cajaActualId,
        fecha_venta: obtenerFechaLocalISO(),
        total_venta: totalVenta,
        usuario_id: usuario,
        detalle_productos: detalle
      }
    ]);

    if (error) {
      console.error("Error al insertar venta:", error.message);
      alert("Error al registrar la venta: " + error.message);
      return;
    }

    // üîΩ DESCONTAR STOCK
    for (const item of carrito) {
      const cantidadVendida = item.cantidadEnCarrito;
      const nuevoStock = item.cantidad - cantidadVendida;

      const { error: errorStock } = await supabase
        .from("productos")
        .update({ cantidad: nuevoStock })
        .eq("id", item.id);

      if (errorStock) {
        console.warn(`‚ùå Error al actualizar stock de ${item.nombre}:`, errorStock.message);
      }
    }

    alert("‚úÖ Venta registrada con √©xito");

    carrito = [];
    actualizarCarrito();
    listarProductos(); // ‚úÖ Actualizar inventario visual

  } catch (e) {
    console.error("Error inesperado en cobrar():", e);
    alert("Error inesperado: " + e.message);
  }
}

async function listarUsuarios() {
  try {
    const { data, error } = await supabase.from("usuarios").select("*");

    if (error) throw error;

    const tabla = document.getElementById("tabla-usuarios");
    tabla.innerHTML = ""; // Limpiar tabla

    data.forEach(usuario => {
      const fila = document.createElement("tr");

      const permisosTexto = Array.isArray(usuario.permisos)
        ? usuario.permisos.join(", ")
        : "";

      let fechaExp = "Sin l√≠mite";
      if (usuario.fecha_expiracion) {
        const fecha = new Date(usuario.fecha_expiracion);
        fechaExp = fecha.toLocaleDateString("es-PE", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit"
        });
      }

      fila.innerHTML = `
        <td>${usuario.usuario}</td>
        <td>${permisosTexto}</td>
        <td>${fechaExp}</td>
        <td><button onclick="eliminarUsuarioPorNombre('${usuario.usuario}')" class="btn-rojo">Eliminar</button></td>
      `;

      tabla.appendChild(fila);
    });

  } catch (err) {
    alert("‚ùå Error al listar usuarios: " + err.message);
  }
}

  async function crearUsuario() {
  const nombre = document.getElementById("nuevo-usuario").value.trim();
  const clave = document.getElementById("nueva-clave").value.trim();
  const fechaExp = document.getElementById("fecha-expiracion").value;
  const permisosSeleccionados = document.querySelectorAll('input.permiso:checked');
  const permisos = Array.from(permisosSeleccionados).map(p => p.value);


  // Validaci√≥n b√°sica
  if (!nombre || !clave || permisos.length === 0) {
    alert("‚ùó Por favor, completa todos los campos y selecciona al menos un permiso.");
    return;
  }

  try {
    // Verificar si ya existe el usuario
    const { data: existente, error: errorExistente } = await supabase
      .from("usuarios")
      .select("usuario")
      .eq("usuario", nombre)
      .single();

    if (existente) {
      alert("‚ùó El nombre de usuario ya est√° registrado. Por favor usa uno diferente.");
      return;
    }

    // Insertar nuevo usuario
    const { error } = await supabase.from("usuarios").insert([{
      usuario: nombre,
      contrasena: clave,
      permisos: permisos,
      fecha_expiracion: fechaExp ? new Date(fechaExp) : null
    }]);

    if (error) {
      throw error;
    }

    alert("‚úÖ Usuario creado exitosamente.");
    document.getElementById("nuevo-usuario").value = "";
    document.getElementById("nueva-clave").value = "";
    document.getElementById("fecha-expiracion").value = "";
    document.querySelectorAll('input[name="permisos"]').forEach(el => el.checked = false);
    listarUsuarios(); // Refrescar lista

  } catch (err) {
    alert("‚ùå Error al crear usuario: " + err.message);
  }
}




  window.eliminarUsuarioPorNombre = async function(nombre) {
    console.log("‚ö†Ô∏è Clic en bot√≥n eliminar para:", nombre);

    if (!confirm(`¬øEliminar usuario '${nombre}'?`)) {
      console.log("üö´ Eliminaci√≥n cancelada");
      return;
    }

    const { error } = await supabase
      .from('usuarios')
      .delete()
      .eq('usuario', nombre);

    if (error) {
      alert("Error al eliminar usuario: " + error.message);
      console.log("‚ùå Supabase error:", error.message);
    } else {
      alert("‚úÖ Usuario eliminado");
      listarUsuarios();
    }
  };


  async function guardarProducto() {
  const nombre = document.getElementById("nombre").value.trim();
  const precio = parseFloat(document.getElementById("precio").value.trim());
  const cantidad = parseInt(document.getElementById("cantidad").value.trim());
  const codigo = document.getElementById("codigo").value.trim();
  const categoria = document.getElementById("categoria").value.trim();
  const sucursal = document.getElementById("sucursal").value.trim();
  const descripcion = document.getElementById("descripcion").value.trim();
  const usuarioActivo = localStorage.getItem('usuarioActivo'); // ‚úÖ CORRECTO

  if (!nombre || isNaN(precio) || isNaN(cantidad) || !codigo || !categoria || !sucursal) {
    alert("Por favor, completa todos los campos obligatorios.");
    return;
  }

  const { error } = await supabase.from('productos').insert([
    {
      nombre,
      precio,
      cantidad,
      codigo,
      categoria,
      sucursal,
      descripcion,
      usuario_productos: usuarioActivo // ‚úÖ CORRECTO
    }
  ]);

  if (error) {
    alert("Error al guardar el producto: " + error.message);
    return;
  }

  alert("‚úÖ Producto guardado exitosamente");
  document.getElementById("form-producto").reset();
  listarProductos();
}

async function listarProductos(filtro = "") {
  const usuarioActivo = localStorage.getItem("usuarioActivo");
  if (!usuarioActivo) return;

  let { data, error } = await supabase
    .from('productos')
    .select('*')
    .eq('usuario_productos', usuarioActivo);

  if (error) return alert("Error al cargar productos");

  // üîç Filtrado local si hay t√©rmino
  if (filtro) {
    const f = filtro.toLowerCase();
    data = data.filter(p =>
      p.nombre.toLowerCase().includes(f) ||
      (p.categoria && p.categoria.toLowerCase().includes(f)) ||
      (p.codigo && p.codigo.toLowerCase().includes(f))
    );
  }

  const tbody = document.getElementById('lista-productos');
  tbody.innerHTML = '';

  data.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="Nombre">${p.nombre}</td>
      <td data-label="Precio">S/ ${p.precio}</td>
      <td data-label="Cantidad">${p.cantidad}</td>
      <td data-label="C√≥digo">${p.codigo}</td>
      <td data-label="Categor√≠a">${p.categoria}</td>
      <td data-label="Sucursal">${p.sucursal}</td>
      <td data-label="Acciones">
        <button onclick="eliminarProducto(${p.id})"
          style="background-color:red;color:white;padding:6px;border:none;border-radius:4px;cursor:pointer;">
          Eliminar
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

  async function eliminarProducto(id) {
    if (!confirm("¬øDeseas eliminar este producto?")) return;
    const { error } = await supabase.from('productos').delete().eq('id', id);
    if (!error) {
      listarProductos();
    }
  }

  async function listarProductosVenta(filtro = "") {
  const usuarioActivo = localStorage.getItem("usuarioActivo");
  if (!usuarioActivo) return;

  let { data, error } = await supabase
    .from("productos")
    .select("*")
    .eq("usuario_productos", usuarioActivo);

  if (error) {
    console.error("‚ùå Error al cargar productos:", error.message);
    return;
  }

  if (filtro) {
    const filtroMin = filtro.toLowerCase();
    data = data.filter(p =>
      p.nombre.toLowerCase().includes(filtroMin) ||
      (p.categoria && p.categoria.toLowerCase().includes(filtroMin)) ||
      (p.codigo && p.codigo.toLowerCase().includes(filtroMin))
    );
  }

  const contenedor = document.getElementById("productos-venta");
  if (!contenedor) return;

  contenedor.innerHTML = "";

  data.forEach(producto => {
    const div = document.createElement("div");
    div.className = "product-card";
    div.innerHTML = `
      <strong>${producto.nombre}</strong><br>
      <small>${producto.categoria}</small><br>
      Precio: S/ ${producto.precio.toFixed(2)}
    `;
    div.onclick = () => agregarAlCarrito(producto);
    contenedor.appendChild(div);
  });
}

  // Variable global para almacenar el producto seleccionado al abrir el modal

  // Modifica agregarAlCarrito para mostrar el modal
  function agregarAlCarrito(producto) {
    console.log(`Intentando agregar producto al carrito: ${producto.nombre}`);

    // Buscar si el producto ya est√° en el carrito
    const productoExistente = carrito.find(item => item.id === producto.id);

    if (productoExistente) {
        // Si ya est√° en el carrito, incrementa la cantidad (si hay stock)
        // 'producto.cantidad' es el stock disponible del producto original
        if (productoExistente.cantidadEnCarrito < producto.cantidad) {
            productoExistente.cantidadEnCarrito++;
            // No es necesario alertar, la UI del carrito lo mostrar√°
        } else {
            alert(`No hay suficiente stock para a√±adir m√°s ${producto.nombre}. Stock disponible: ${producto.cantidad}`);
        }
    } else {
        // Si no est√° en el carrito, a√±√°delo con cantidad 1
        if (producto.cantidad > 0) { // Solo a√±adir si hay stock inicial
            // A√±ade una nueva propiedad 'cantidadEnCarrito'
            carrito.push({ ...producto, cantidadEnCarrito: 1 });
            // No es necesario alertar
        } else {
            alert(`"${producto.nombre}" est√° agotado.`);
        }
    }

    // Siempre actualiza la visualizaci√≥n del carrito despu√©s de cualquier cambio
    actualizarCarrito();
}

  function actualizarCarrito() {
    const lista = document.getElementById('carrito-lista'); // ‚úÖ Aseg√∫rate que este ID exista en tu HTML
    const total = document.getElementById('carrito-total'); // ‚úÖ Aseg√∫rate que este ID exista en tu HTML

    // Es crucial que 'lista' y 'total' no sean null. Si lo son, este error ocurrir√°.
    // El error `Cannot set properties of null` ocurre porque 'lista' es null cuando se ejecuta esta l√≠nea:
    // lista.innerHTML = '';
    // Esto solo deber√≠a ocurrir si el script intenta ejecutarse antes que el DOM est√© listo,
    // o si los IDs 'carrito-lista' o 'carrito-total' no existen en el HTML.
    // Pero en tu HTML s√≠ existen, lo que nos lleva a pensar que el DOM no est√° completamente cargado.
    // La soluci√≥n a esto es asegurar que `actualizarCarrito()` se llama cuando el DOM est√° listo.

    // A√±adimos una verificaci√≥n para evitar el error si por alguna raz√≥n los elementos no est√°n disponibles a√∫n
    if (!lista || !total) {
        console.error("Elementos 'carrito-lista' o 'carrito-total' no encontrados. El DOM podr√≠a no estar completamente cargado.");
        return; // Salir de la funci√≥n si los elementos no existen
    }

    lista.innerHTML = ''; // Limpiar el carrito actual

    let suma = 0;

    carrito.forEach((p, index) => {
        const li = document.createElement("li");
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.marginBottom = '10px';

        suma += p.precio * p.cantidadEnCarrito; // Usar cantidadEnCarrito para el total

        // Crear el texto del producto
        const textoProducto = document.createElement('span');
        textoProducto.textContent = `${p.nombre} (S/ ${p.precio.toFixed(2)} c/u)`;
        li.appendChild(textoProducto);

        // Contenedor para cantidad y botones
        const controles = document.createElement('div');
        controles.style.display = 'flex';
        controles.style.alignItems = 'center';

        // Bot√≥n para disminuir cantidad
        const btnDisminuir = document.createElement('button');
        btnDisminuir.textContent = '-';
        btnDisminuir.style.marginRight = '5px';
        btnDisminuir.style.padding = '5px 10px';
        btnDisminuir.style.backgroundColor = '#ccc';
        btnDisminuir.style.border = 'none';
        btnDisminuir.style.borderRadius = '3px';
        btnDisminuir.style.cursor = 'pointer';
        btnDisminuir.onclick = () => { // Usar onclick para simplificar
            if (p.cantidadEnCarrito > 1) {
                p.cantidadEnCarrito--;
            } else {
                // Si la cantidad llega a 0, eliminar del carrito
                carrito.splice(index, 1);
            }
            actualizarCarrito(); // Volver a renderizar el carrito
        };
        controles.appendChild(btnDisminuir);

        // Input de cantidad
        const inputCantidad = document.createElement('input');
        inputCantidad.type = 'number';
        inputCantidad.value = p.cantidadEnCarrito;
        inputCantidad.min = '1';
        inputCantidad.max = p.cantidad; // El stock disponible del producto original
        inputCantidad.style.width = '50px';
        inputCantidad.style.textAlign = 'center';
        inputCantidad.style.margin = '0 5px';
        inputCantidad.style.padding = '5px';
        inputCantidad.style.border = '1px solid #ccc';
        inputCantidad.style.borderRadius = '3px';
        inputCantidad.onchange = (e) => { // Usar onchange para actualizar al cambiar
            let nuevaCantidad = parseInt(e.target.value);
            if (isNaN(nuevaCantidad) || nuevaCantidad < 1) {
                nuevaCantidad = 1; // Si no es un n√∫mero v√°lido o es menor que 1, establecer a 1
            }
            if (nuevaCantidad > p.cantidad) { // No exceder el stock disponible
                alert(`No hay suficiente stock para a√±adir ${nuevaCantidad} unidades de ${p.nombre}. Stock disponible: ${p.cantidad}`);
                nuevaCantidad = p.cantidad; // Establecer al m√°ximo stock
            }
            p.cantidadEnCarrito = nuevaCantidad;
            actualizarCarrito(); // Volver a renderizar el carrito
        };
        controles.appendChild(inputCantidad);

        // Bot√≥n para aumentar cantidad
        const btnAumentar = document.createElement('button');
        btnAumentar.textContent = '+';
        btnAumentar.style.marginLeft = '5px';
        btnAumentar.style.padding = '5px 10px';
        btnAumentar.style.backgroundColor = '#ccc';
        btnAumentar.style.border = 'none';
        btnAumentar.style.borderRadius = '3px';
        btnAumentar.style.cursor = 'pointer';
        btnAumentar.onclick = () => { // Usar onclick para simplificar
            if (p.cantidadEnCarrito < p.cantidad) { // No exceder el stock disponible
                p.cantidadEnCarrito++;
            } else {
                alert(`No hay m√°s stock disponible para ${p.nombre}.`);
            }
            actualizarCarrito(); // Volver a renderizar el carrito
        };
        controles.appendChild(btnAumentar);

        // Bot√≥n para eliminar el producto del carrito
        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = 'X';
        btnEliminar.style.marginLeft = '10px';
        btnEliminar.style.padding = '5px 10px';
        btnEliminar.style.backgroundColor = '#d9534f'; // Rojo
        btnEliminar.style.color = 'white';
        btnEliminar.style.border = 'none';
        btnEliminar.style.borderRadius = '3px';
        btnEliminar.style.cursor = 'pointer';
        btnEliminar.onclick = () => { // Usar onclick para simplificar
            carrito.splice(index, 1); // Eliminar del array
            actualizarCarrito(); // Volver a renderizar el carrito
        };
        controles.appendChild(btnEliminar);

        li.appendChild(controles);
        lista.appendChild(li);
    });

    total.textContent = suma.toFixed(2);
}

  // Enlaza el formulario al evento de creaci√≥n de usuario
  document.addEventListener('DOMContentLoaded', () => {
  const usuarioActivo = localStorage.getItem("usuarioActivo");
  const permisos = JSON.parse(localStorage.getItem("permisosUsuario") || "[]");

  if (usuarioActivo && permisos.length > 0) {
    // ‚úÖ Ya hay sesi√≥n: mostrar app directamente
    document.getElementById('login').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');

    const contenedor = document.getElementById("usuario-logueado");
    if (contenedor) contenedor.textContent = `üë§ Usuario: ${usuarioActivo}`;

    aplicarPermisosDelUsuario({ permisos });

    mostrarPanel("venta"); // Panel por defecto al restaurar sesi√≥n
  } else {
    // Si no hay sesi√≥n, se espera al login manual
    document.getElementById('btn-login')?.addEventListener('click', login);
  }

  // ‚úÖ Carga de datos general (funciona est√© o no logueado)
  listarUsuarios(); 
  listarProductos();
  listarCajas();
  listarPlatosRestaurante();
  mostrarPlatosMesas();
  listarPedidos();
  listarHistorialPedidos();

  const inputBusqueda = document.getElementById("busqueda-producto");
  if (inputBusqueda) {
    inputBusqueda.addEventListener("input", (e) => {
      const valor = e.target.value.trim();
      listarProductosVenta(valor);
    });
  }

  const form = document.querySelector('form[onsubmit*="crearUsuario"]');
  if (form) {
    form.addEventListener('submit', e => {
      e.preventDefault();
      crearUsuario();
    });
  }

  const formProducto = document.getElementById('form-producto');
  if (formProducto) {
    formProducto.addEventListener('submit', (e) => {
      e.preventDefault();
      guardarProducto();  
    });
  }

  const inputBusquedaInv = document.getElementById("busqueda-inventario");
    if (inputBusquedaInv) {
      inputBusquedaInv.addEventListener("input", (e) => {
      const valor = e.target.value.trim();
      listarProductos(valor);
    });
  }

});

// aqui estaba el codigo -->

document.getElementById('form-apertura').addEventListener('submit', async function (e) {
  e.preventDefault();
  const usuario = localStorage.getItem("usuarioActivo");
  console.log("Usuario activo:", usuario);
  const saldoInicial = parseFloat(document.getElementById('saldoInicial').value);
  const sucursal = document.getElementById('sucursalCaja').value;

  const { data, error } = await supabase.from('cajas').insert([{
    usuario_id: usuario,
    fecha_apertura: obtenerFechaLocalISO(),
    saldo_inicial: saldoInicial,
    estado: 'abierta',
    sucursal: sucursal
  }]).select().single();

  if (error) {
    alert('Error al abrir caja: ' + error.message);
    return;
  }

  cajaActualId = data.id;
  alert("‚úÖ Caja abierta correctamente");
  listarCajas();
});

function obtenerFechaLocalISO() {
  const offsetMs = new Date().getTimezoneOffset() * 60000;
  return new Date(Date.now() - offsetMs).toISOString();
}

async function cerrarCaja() {
  if (!cajaActualId) {
    alert("No hay caja abierta actualmente.");
    return;
  }

  const { data: ventas, error: errorVentas } = await supabase
    .from('registros_venta')
    .select('total_venta')
    .eq('caja_id', cajaActualId);

  if (errorVentas) {
    alert("Error al obtener ventas: " + errorVentas.message);
    return;
  }

  const totalVentas = ventas.reduce((sum, v) => sum + parseFloat(v.total_venta), 0);

  const { data: cajaActual, error: errorCajaActual } = await supabase
  .from("cajas")
  .select("saldo_inicial")
  .eq("id", cajaActualId)
  .single();

  if (errorCajaActual) {
    alert("Error al obtener saldo inicial de la caja");
  return;
  }


  const { error } = await supabase
    .from('cajas')
    .update({
      fecha_cierre: obtenerFechaLocalISO(),
      saldo_final: totalVentas > 0 ? totalVentas : cajaActual.saldo_inicial,
      ventas_totales: totalVentas,
      estado: 'cerrada'
    })
    .eq('id', cajaActualId);

  if (error) {
    alert("Error al cerrar la caja: " + error.message);
    return;
  }

  alert("‚úÖ Caja cerrada exitosamente.");
  cajaActualId = null;
  listarCajas();
}

async function listarCajas() {
  const usuarioActivo = localStorage.getItem("usuarioActivo");
  const esAdmin = usuarioActivo === "ADMIN";

  let consulta = supabase.from('cajas').select('*');
  if (!esAdmin) {
    consulta = consulta.eq('usuario_id', usuarioActivo);
  }

  const { data, error } = await consulta.order('fecha_apertura', { ascending: false });

  if (error) {
    alert("Error al listar cajas: " + error.message);
    return;
  }

  const tbody = document.getElementById("tabla-cajas");
  tbody.innerHTML = "";

  data.forEach(caja => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
  <td data-label="Fecha Apertura">${new Date(caja.fecha_apertura).toLocaleString()}</td>
  <td data-label="Saldo Inicial">${caja.saldo_inicial || '-'}</td>
  <td data-label="Fecha Cierre">${caja.fecha_cierre ? new Date(caja.fecha_cierre).toLocaleString() : '-'}</td>
  <td data-label="Saldo Final">${caja.saldo_final ?? '-'}</td>
  <td data-label="Ventas Totales">${caja.ventas_totales ?? '-'}</td>
  <td data-label="Estado">${caja.estado}</td>
  <td data-label="Sucursal">${caja.sucursal}</td>
  `;
    tbody.appendChild(tr);

    if (caja.estado === 'abierta') {
      cajaActualId = caja.id;
    }
  });
}

document.addEventListener("DOMContentLoaded", listarCajas);

   // Expone funciones globales para HTML
  window.login = login;
  window.crearUsuario = crearUsuario;
  window.mostrarPanel = mostrarPanel;
  window.cerrarSesion = function () {
    localStorage.removeItem("usuarioActivo");
    location.reload(); // Reinicia la app al login
  };
  window.listarProductosVenta = listarProductosVenta;
  window.cobrar = cobrar;
  window.eliminarProducto = eliminarProducto;
  window.agregarAlCarrito = agregarAlCarrito; // <-- ¬°A√±ade esta l√≠nea!
  window.cerrarCaja = cerrarCaja;
  window.registrarPedido = registrarPedido;
  window.eliminarPedido = eliminarPedido;
  window.cobrarPedido = cobrarPedido;

</script>
</body>
</html>
